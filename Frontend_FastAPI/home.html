<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GeoSthira IP Geolocator üåç</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* ===== Input Validation Styling ===== */
        .error-msg {
            color: #e53e3e;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }
        .highlight {
            border-color: #e53e3e !important;
            background-color: #fff5f5;
        }
        /* ===== General Table Styling ===== */
        table {
            border-collapse: collapse;
            width: 95%;
            margin: 25px auto;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #edf2f7;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8fafc;
        }
    </style>
</head>
<body>
    <!-- ===== Header ===== -->
    <header>
        <div class="logo-container">
            <img src="/static/logo.png" alt="GeoSthira Logo" class="logo">
            <h1>GeoSthira IP Geolocator</h1>
        </div>
        <p class="subtitle">Predict your IP‚Äôs Indian city using our trained ML model</p>
    </header>

    <!-- ===== Main Section ===== -->
    <main>
        <form id="ipForm" method="post" action="/predict" enctype="multipart/form-data" class="input-form">
            <label>Single IP Address:</label>
            <input type="text" id="ip_single" name="ip_single" placeholder="e.g. 13.71.49.222">
            <p id="ip_error_single" class="error-msg">‚ùå Invalid IP ‚Äî each octet must be between 0‚Äì255</p>

            <label>Multiple IPs (comma-separated):</label>
            <textarea id="ip_multiple" name="ip_multiple" placeholder="e.g. 13.71.49.222, 61.246.138.73"></textarea>
            <p id="ip_error_multi" class="error-msg">‚ùå One or more IPs are invalid ‚Äî check your entries</p>

            <label>Or Upload CSV (with ‚ÄòIP‚Äô column):</label>
            <input type="file" name="csv_file" accept=".csv">

            <p class="note">üíª Smart automation connects WHOIS, IPAPI & AI for location accuracy!</p>

            <button type="submit">Locate IP</button>
        </form>

        {% if error %}
        <div class="error-box">{{ error }}</div>
        {% endif %}

        {% if results %}
        <section class="results">
            <h2>üîç Results</h2>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Predicted City / Message</th>
                            <th>Confidence (%)</th>
                            <th>Error Bound (%)</th>
                            <th>WHOIS ASN</th>
                            <th>WHOIS Country</th>
                            <th>IPAPI City</th>
                            <th>Match (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for r in results %}
                        <tr>
                            <td>{{ r['IP'] }}</td>
                            <td>{{ r['Predicted_City'] }}</td>
                            <td>{{ r['Confidence (%)'] }}</td>
                            <td>{{ r['Error Bound (%)'] }}</td>
                            <td>{{ r['WHOIS_ASN'] or '-' }}</td>
                            <td>{{ r['WHOIS_Country'] or '-' }}</td>
                            <td>{{ r['IPAPI_City'] or '-' }}</td>
                            <td>{{ r['Match (%)'] or '-' }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}
    </main>

    <!-- ===== Footer ===== -->
    <footer>
        <p>üåê Team GeoSthira | For support: <a href="mailto:geosthira@gmail.com">geosthira@gmail.com</a></p>
    </footer>

    <!-- ===== IP Validation Script ===== -->
    <script>
        const ipSingle = document.getElementById("ip_single");
        const ipMulti = document.getElementById("ip_multiple");
        const errSingle = document.getElementById("ip_error_single");
        const errMulti = document.getElementById("ip_error_multi");
        const form = document.getElementById("ipForm");

        function isValidIP(ip) {
            const parts = ip.trim().split(".");
            if (parts.length !== 4) return false;
            return parts.every(p => /^\d+$/.test(p) && Number(p) >= 0 && Number(p) <= 255);
        }

        // Validate single IP on input
        ipSingle.addEventListener("input", () => {
            const value = ipSingle.value.trim();
            if (value && !isValidIP(value)) {
                ipSingle.classList.add("highlight");
                errSingle.style.display = "block";
            } else {
                ipSingle.classList.remove("highlight");
                errSingle.style.display = "none";
            }
        });

        // Validate multiple IPs on input
        ipMulti.addEventListener("input", () => {
            const value = ipMulti.value.trim();
            if (!value) {
                ipMulti.classList.remove("highlight");
                errMulti.style.display = "none";
                return;
            }
            const ips = value.split(",").map(x => x.trim()).filter(x => x);
            const invalid = ips.some(ip => !isValidIP(ip));
            if (invalid) {
                ipMulti.classList.add("highlight");
                errMulti.style.display = "block";
            } else {
                ipMulti.classList.remove("highlight");
                errMulti.style.display = "none";
            }
        });

        // Block submission if invalid
        form.addEventListener("submit", (e) => {
            const single = ipSingle.value.trim();
            const multi = ipMulti.value.trim();

            let invalid = false;

            if (single && !isValidIP(single)) {
                invalid = true;
                ipSingle.classList.add("highlight");
                errSingle.style.display = "block";
            }

            if (multi) {
                const ips = multi.split(",").map(x => x.trim()).filter(x => x);
                if (ips.some(ip => !isValidIP(ip))) {
                    invalid = true;
                    ipMulti.classList.add("highlight");
                    errMulti.style.display = "block";
                }
            }

            if (invalid) {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: "smooth" });
            }
        });
    </script>
</body>
</html>
